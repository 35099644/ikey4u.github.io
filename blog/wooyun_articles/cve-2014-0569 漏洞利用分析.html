<html>
<head>
     <title>cve-2014-0569 漏洞利用分析 - 绿盟科技</title>
	 <meta http-equiv="content-type" content="text/html; charset=UTF-8">
</head>
<body>
<h1>URL:<a href="http://drops.wooyun.org/papers/4024">http://drops.wooyun.org/papers/4024</a></h1>

      <p>
        <h1>0×00 简述</h1>

<hr />

<p>来自CVE的漏洞描述：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/01b956faf377ca16fed5c212cb9282f2.jpg" alt="enter image description here" /></p>

<p>测试环境： Win7 SP1 + Flash ActiveX 15.0.0.167</p>

<!--more-->

<h1>0×01 漏洞利用分析</h1>

<hr />

<p>介绍有关漏洞关键代码前，先看一下heap spray后的内存布局：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/3444104448ab0f849412b27148effa7f.jpg" alt="enter image description here" /></p>

<p>简单描述为：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/db59ba01e9eeb93292d0095291c465a9.jpg" alt="enter image description here" /></p>

<p>漏洞致使Uint Vector的length字段被改写。</p>

<p>漏洞关键代码：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/bbf2f89edca71131502e06d79bf252f6.jpg" alt="enter image description here" /></p>

<p>红线标注的部分其操作流程：</p>

<p>取预定大小0×1000的ByteArray对象_loc3，赋值给domainMemory，以便casi32函数操作此内存</p>

<p>预置大小0×1000的ByteArray对象：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/e5f1f110041c49dbe9a0b1d07266df35.jpg" alt="enter image description here" /></p>

<p>通过函数atomicCompareAndSwapLength将_loc3长度置0</p>

<p>casi32函数内由于整数溢出造成执行流改变，致使向_loc3偏移0×1000处成功写入0×40000001</p>

<p>上述过程细节：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/ab78c3c4d18705185189d5d686d98d7a.jpg" alt="enter image description here" /></p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/c9ef01f028e69dbad03685f2ac78ff8d.jpg" alt="enter image description here" /></p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/306a1e994dfe417a6951a084da91ce82.jpg" alt="enter image description here" /></p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/747199182f9e964a86556631b2ed438c.jpg" alt="enter image description here" /></p>

<p>这样就可以以超长的Uint Vector为起点，读取预置的对象数据。</p>

<p>利用关键点：</p>

<p>搜索预置的sound对象进而计算出flash控件基址</p>

<p>预置的sound对象包含于喷射的少量Vector Object里，这里称之为vec_3。</p>

<p>具体的喷射代码：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/b51f697ab0282080b1e939de3edec199.jpg" alt="enter image description here" /></p>

<p>通过特征比对遍历以获取vec_3中元素：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/78ac559f5e22d4761fedfb418fe0df03.jpg" alt="enter image description here" /></p>

<p>搜索到的其中一项：</p>

<p>计算flash控件基址：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/1f930ae3fd1d20f231a0ab32a8bf6774.jpg" alt="enter image description here" /></p>

<p>在flash控件基址基础上获取rop链所需指令，用VirtualAlloc分配可执行内存过DEP。</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/3fccbd946ff0fcbd35f98dc8d9495311.jpg" alt="enter image description here" /></p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/8dc979780c95040ec5e6c8977805f266.jpg" alt="enter image description here" /></p>

<p>构造rop链（部分）：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/abcfe030d5972784eab904cf5b2d8c1a.jpg" alt="enter image description here" /></p>

<p>修改sound对象虚表指针，并调用修改后的虚表函数将执行流导向stack pivot。</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/0b7f73942ee7cfe80a82bd740b41e982.jpg" alt="enter image description here" /></p>

<p>sound对象虚表指针修改前后：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/66b0ba851e2b7f26c304ec43f342d3a3.jpg" alt="enter image description here" /></p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/cb1350d9723c59ae4907e9c15762cee5.jpg" alt="enter image description here" /></p>

<p>修改后的虚表指针指向内容：</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/4e71fa5f1dbd9879bc7bedd2f9ce0970.jpg" alt="enter image description here" /></p>

<p>调用虚函数触发利用。</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/95544c405bd68839127be93258a4bed7.jpg" alt="enter image description here" /></p>

<h1>0×02 分析总结</h1>

<hr />

<p>完整的利用至少由两部分组成（html + swf），其中swf并不能独立执行，需要html传入的参数（shellcode），只拿到swf并不能获知攻击者的意图。</p>

<h1>0×03 参考文章</h1>

<hr />

<ol>
<li><p><a href="http://weibo.com/p/1001603769606924861349">CVE-2014-0569漏洞分析</a></p></li>
<li><p><a href="http://blogs.technet.com/b/mmpc/archive/2014/11/05/cracking-the-cve-2014-0569-nutshell.aspx">Cracking the CVE-2014-0569 nutshell</a></p></li>
</ol>      </p>
    
</body>
</html>